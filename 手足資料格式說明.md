# 手足資料格式說明

## 概述

系統現在支援**兩種方式**來處理手足資料：

1. **字串格式解析**：從「兄弟姊妹」欄位解析
2. **家長姓名判斷**：根據「家長姓名」自動判斷手足關係

---

## 方式一：字串格式解析

### 適用情況

如果您的 Excel 檔案中有「兄弟姊妹」、「手足」或「兄弟姐妹」欄位，且內容格式為：

```
姓名（性別, 年級）、姓名（性別, 年級）
```

### 支援的格式

#### 標準格式（全形括號）
```
小明（男, 二年級）、小美（女, 四年級）
溫新（男, 三年級）、溫柔知（女, 大班）
```

#### 半形括號
```
小明(男, 二年級)、小美(女, 四年級)
李大華(男,五年級)，李小華(女,三年級)
```

#### 單一手足
```
張小強（男, 一年級）
```

#### 無手足
```
無
（空白）
```

### 解析規則

1. **分隔符**：使用「、」或「，」分隔不同手足
2. **格式**：每位手足的格式為 `姓名（性別, 年級）`
3. **括號**：支援全形 `（）` 和半形 `()` 括號
4. **逗號**：性別和年級之間用逗號分隔

### 解析結果

輸入：
```
小明（男, 二年級）、小美（女, 四年級）
```

解析後：
```javascript
{
  names: ['小明', '小美'],
  genders: ['男', '女'],
  grades: ['二年級', '四年級']
}
```

### Excel 輸出

#### 年級分頁（手足資料不展開）
```
| 兒童姓名 | 手足名稱      | 手足性別 | 手足年級        |
|---------|--------------|---------|----------------|
| 王小華   | 小明, 小美    | 男, 女   | 二年級, 四年級  |
```

#### 總表分頁（手足資料展開）
```
| 項次 | 兒童姓名 | 手足名稱 | 手足性別 | 手足年級 |
|-----|---------|---------|---------|---------|
| 1   | 王小華   | 小明     | 男       | 二年級   |
| 2   | 王小華   | 小美     | 女       | 四年級   |
```

---

## 方式二：家長姓名判斷

### 適用情況

如果您的 Excel 檔案中**沒有**「兄弟姊妹」欄位，系統會自動根據「家長姓名」判斷手足關係。

### 判斷邏輯

1. 系統會建立「家長姓名」對應表
2. 找出同一個家長的所有孩子
3. 排除當前孩子，剩下的就是手足

### 範例

#### 輸入資料

| 兒童姓名 | 性別 | 年級   | 家長姓名 |
|---------|------|-------|---------|
| 王小明   | 男   | 二年級 | 王大華   |
| 王小美   | 女   | 四年級 | 王大華   |
| 李小華   | 男   | 一年級 | 李媽媽   |

#### 處理結果

**王小明的手足**：
```javascript
{
  names: ['王小美'],
  genders: ['女'],
  grades: ['四年級']
}
```

**王小美的手足**：
```javascript
{
  names: ['王小明'],
  genders: ['男'],
  grades: ['二年級']
}
```

**李小華的手足**：
```javascript
{
  names: [],
  genders: [],
  grades: []
}
```

---

## 優先順序

系統會按照以下優先順序處理手足資料：

1. **優先**：檢查「兄弟姊妹」、「手足」、「兄弟姐妹」欄位
2. **次要**：如果上述欄位不存在或為空，則使用「家長姓名」判斷

---

## 技術實作

### 後端（Node.js）

#### 字串解析函數

```javascript
/**
 * 解析手足資料字串
 * 輸入格式：小明（男, 二年級）、小美（女, 四年級）
 * 輸出：{ names: ['小明', '小美'], genders: ['男', '女'], grades: ['二年級', '四年級'] }
 */
function parseSiblingString(siblingStr) {
  if (!siblingStr || siblingStr === '無' || String(siblingStr).trim() === '') {
    return { names: [], genders: [], grades: [] };
  }

  const names = [];
  const genders = [];
  const grades = [];

  // 使用正則表達式找出所有符合「姓名（性別, 年級）」格式的手足
  const pattern = /([^、，,]+?)[（(]([^,，]+?)[,，]\s*([^）)]+?)[）)]/g;
  
  let match;
  while ((match = pattern.exec(String(siblingStr))) !== null) {
    const [, name, gender, grade] = match;
    names.push(name.trim());
    genders.push(gender.trim());
    grades.push(grade.trim());
  }

  return { names, genders, grades };
}
```

#### 手足資訊獲取函數

```javascript
function getSiblings(currentChild, parentMap) {
  // 優先檢查是否有「兄弟姊妹」欄位
  const siblingField = currentChild['兄弟姊妹'] || currentChild['手足'] || currentChild['兄弟姐妹'];
  
  if (siblingField && String(siblingField).trim() !== '' && String(siblingField).trim() !== '無') {
    // 使用字串解析方式
    return parseSiblingString(siblingField);
  }

  // 否則使用家長姓名判斷手足關係
  const parentName = currentChild['家長姓名'];
  const currentChildName = currentChild['兒童姓名'];

  if (!parentName || String(parentName).trim() === '') {
    return { names: [], genders: [], grades: [] };
  }

  const trimmedParentName = String(parentName).trim();
  const allChildren = parentMap.get(trimmedParentName) || [];

  // 過濾掉當前孩子，剩下的就是手足
  const siblings = allChildren.filter(child => child.兒童姓名 !== currentChildName);

  return {
    names: siblings.map(s => s.兒童姓名),
    genders: siblings.map(s => s.性別),
    grades: siblings.map(s => s.年級)
  };
}
```

### 前端（React）

如果需要在前端解析手足字串：

```typescript
interface SiblingInfo {
  names: string[];
  genders: string[];
  grades: string[];
}

function parseSiblingString(siblingStr: string): SiblingInfo {
  if (!siblingStr || siblingStr === '無' || siblingStr.trim() === '') {
    return { names: [], genders: [], grades: [] };
  }

  const names: string[] = [];
  const genders: string[] = [];
  const grades: string[] = [];

  const pattern = /([^、，,]+?)[（(]([^,，]+?)[,，]\s*([^）)]+?)[）)]/g;
  
  let match;
  while ((match = pattern.exec(siblingStr)) !== null) {
    const [, name, gender, grade] = match;
    names.push(name.trim());
    genders.push(gender.trim());
    grades.push(grade.trim());
  }

  return { names, genders, grades };
}

// 使用範例
const siblingStr = '小明（男, 二年級）、小美（女, 四年級）';
const result = parseSiblingString(siblingStr);
console.log(result);
// { names: ['小明', '小美'], genders: ['男', '女'], grades: ['二年級', '四年級'] }
```

---

## 測試範例

### 測試案例

```javascript
const testCases = [
  {
    input: '小明（男, 二年級）、小美（女, 四年級）',
    expected: {
      names: ['小明', '小美'],
      genders: ['男', '女'],
      grades: ['二年級', '四年級']
    }
  },
  {
    input: '溫新（男, 三年級）、溫柔知（女, 大班）',
    expected: {
      names: ['溫新', '溫柔知'],
      genders: ['男', '女'],
      grades: ['三年級', '大班']
    }
  },
  {
    input: '張小強（男, 一年級）',
    expected: {
      names: ['張小強'],
      genders: ['男'],
      grades: ['一年級']
    }
  },
  {
    input: '無',
    expected: {
      names: [],
      genders: [],
      grades: []
    }
  },
  {
    input: '李大華(男,五年級)，李小華(女,三年級)',
    expected: {
      names: ['李大華', '李小華'],
      genders: ['男', '女'],
      grades: ['五年級', '三年級']
    }
  }
];
```

---

## 常見問題

### Q1: 如果 Excel 同時有「兄弟姊妹」欄位和「家長姓名」，系統會用哪個？

**A**: 系統會優先使用「兄弟姊妹」欄位。只有當該欄位不存在或為空時，才會使用「家長姓名」判斷。

### Q2: 如果「兄弟姊妹」欄位的格式不正確會怎樣？

**A**: 如果格式不符合 `姓名（性別, 年級）` 的規範，該手足資料會被忽略，系統會嘗試解析其他符合格式的手足。

### Q3: 支援哪些欄位名稱？

**A**: 系統支援以下欄位名稱（不區分大小寫）：
- `兄弟姊妹`
- `手足`
- `兄弟姐妹`

### Q4: 可以混用全形和半形括號嗎？

**A**: 可以！系統同時支援全形 `（）` 和半形 `()` 括號。

### Q5: 如果只有姓名沒有性別和年級會怎樣？

**A**: 目前系統要求完整的格式 `姓名（性別, 年級）`。如果格式不完整，該筆資料會被忽略。

---

## 版本記錄

- **v1.2.2** (2024-11-25) - 新增字串格式手足資料解析功能
- **v1.2.1** (2024-11-25) - 總表手足資料展開
- **v1.2.0** (2024-11-25) - 新增總表分頁
- **v1.0.0** (2024-11-24) - 初始版本（僅支援家長姓名判斷）

---

## 相關文件

- `README.md` - 專案主要說明
- `總表功能說明.md` - 總表功能詳細說明
- `欄位說明.md` - Excel 欄位說明
- `更新日誌.md` - 完整版本更新記錄
