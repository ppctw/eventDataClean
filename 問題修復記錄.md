# 問題修復記錄

## 2024-11-25 修復記錄

### 問題 1: 前端顯示空的錯誤訊息

**症狀**:
```
[ERROR] 上傳錯誤: {}
```

**原因**:
- 前端使用 `responseType: 'blob'` 接收檔案
- 當後端回傳 500 錯誤時，錯誤訊息也被當作 Blob 處理
- Axios 無法直接解析 Blob 格式的 JSON 錯誤訊息

**解決方法**:
修改 `frontend/src/api/uploadApi.ts`，加入 Blob 錯誤訊息的解析：

```typescript
if (error.response.data instanceof Blob) {
  try {
    const text = await error.response.data.text();
    const errorData = JSON.parse(text);
    throw new Error(`上傳失敗: ${error.response.status} - ${errorData.message || errorData.error}`);
  } catch (parseError) {
    throw new Error(`上傳失敗: ${error.response.status} - ${error.response.statusText}`);
  }
}
```

---

### 問題 2: HTTP Header 中的中文字元錯誤

**症狀**:
```
TypeError [ERR_INVALID_CHAR]: Invalid character in header content ["Content-Disposition"]
```

**原因**:
- HTTP Header 不支援直接使用中文字元
- 原本的檔名：`整理後的報名資料_${Date.now()}.xlsx`

**解決方法**:
修改 `backend/src/routes/uploadRoutes.js`，使用 RFC 5987 編碼：

```javascript
const filename = `processed_${Date.now()}.xlsx`;
const encodedFilename = encodeURIComponent('整理後的報名資料.xlsx');

res.setHeader('Content-Disposition', 
  `attachment; filename="${filename}"; filename*=UTF-8''${encodedFilename}`);
```

這樣瀏覽器會優先使用 UTF-8 編碼的中文檔名，如果不支援則使用英文檔名。

---

### 問題 3: Excel 欄位名稱包含換行符

**症狀**:
```
Excel 中的欄位: [
  '家長\r\n姓名',
  '家長\r\n行動電話'
]
警告：缺少以下欄位: [ '家長姓名', '家長行動電話' ]
```

**原因**:
- Excel 儲存格中的欄位名稱包含換行符（`\r\n`）
- 系統無法匹配到正確的欄位名稱

**解決方法**:
修改 `backend/src/services/excelService.js`，在讀取資料後清理欄位名稱：

```javascript
// 清理欄位名稱（移除換行符、空格等）並重新對應資料
const cleanedData = rawData.map(row => {
  const cleanedRow = {};
  for (const [key, value] of Object.entries(row)) {
    // 清理欄位名稱：移除 \r\n, \n, \r 和多餘空格
    const cleanKey = key.replace(/[\r\n]+/g, '').trim();
    cleanedRow[cleanKey] = value;
  }
  return cleanedRow;
});
```

---

## 修復效果

### 修復前
- ❌ 前端只顯示空的錯誤物件 `{}`
- ❌ 後端因為 HTTP Header 錯誤而無法回傳檔案
- ❌ 無法識別包含換行符的欄位名稱

### 修復後
- ✅ 前端能正確顯示詳細的錯誤訊息
- ✅ 後端能正確設定中文檔名並回傳檔案
- ✅ 自動清理欄位名稱中的換行符和空格
- ✅ 能正確處理各種格式的 Excel 檔案

---

## 測試結果

使用實際的 Excel 檔案測試：

```
讀取到 288 筆資料
Excel 中的欄位（已清理）: [
  '項次',
  '報名序號',
  '兒童姓名',
  '性別',
  '年級',
  '學校',
  '家長姓名',        ← 已清理換行符
  '家長行動電話',    ← 已清理換行符
  ...
]
建立分頁: 一年級, 共 41 筆資料
建立分頁: 二年級, 共 49 筆資料
建立分頁: 三年級, 共 38 筆資料
...
處理完成 ✅
```

---

## 學到的經驗

### 1. Blob 錯誤處理

當使用 `responseType: 'blob'` 時，錯誤回應也會是 Blob 格式，需要：
1. 檢查 `error.response.data instanceof Blob`
2. 使用 `.text()` 轉換成文字
3. 使用 `JSON.parse()` 解析 JSON

### 2. HTTP Header 編碼

中文檔名需要使用 RFC 5987 編碼：
```
filename="fallback.xlsx"; filename*=UTF-8''%E4%B8%AD%E6%96%87%E6%AA%94%E5%90%8D.xlsx
```

### 3. Excel 欄位清理

Excel 儲存格可能包含：
- 換行符：`\r\n`, `\n`, `\r`
- 前後空格
- 其他不可見字元

建議統一清理：
```javascript
key.replace(/[\r\n]+/g, '').trim()
```

---

## 未來改進建議

### 1. 更強大的欄位對應

考慮實作「模糊匹配」功能：
- 「家長姓名」可以匹配「家長名字」、「監護人姓名」等
- 「兒童姓名」可以匹配「學生姓名」、「小朋友姓名」等

### 2. 前端預覽功能

在上傳前顯示：
- 檔案中有哪些欄位
- 哪些欄位會被使用
- 哪些欄位會被忽略

### 3. 自訂欄位對應

讓使用者可以在前端設定：
```
Excel 欄位 → 系統欄位
「學生姓名」 → 「兒童姓名」
「家長電話」 → 「家長行動電話」
```

### 4. 批次處理

支援一次上傳多個 Excel 檔案，合併處理。

---

## 相關文件

- `欄位說明.md` - 詳細的欄位說明
- `快速參考.md` - 快速使用指南
- `SYSTEM_FLOW.md` - 系統流程說明

---

## 版本記錄

- **v1.0.0** (2024-11-24) - 初始版本
- **v1.1.0** (2024-11-25) - 修復錯誤訊息、HTTP Header 和欄位清理問題
