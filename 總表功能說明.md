# 總表功能說明

## 功能概述

系統會自動建立一個「總表」分頁，將所有處理過的資料彙整在一起，並依照報名序號進行排序。

---

## 總表特色

### 1. **第一個分頁**
總表會放在 Excel 檔案的第一個分頁，方便快速查看所有資料。

### 2. **依報名序號排序**
所有資料會依照「報名序號」進行正排序（由小到大）。

例如：
```
報名序號 1
報名序號 2
報名序號 3
...
報名序號 100
```

### 3. **手足資料展開**
如果一個學生有多個手足，會將手足資料展開成多列：

**原始格式（藍色）**：
```
項次 | 報名序號 | 兒童姓名 | 手足名稱      | 手足性別 | 手足年級
1    | 022      | 溫河     | 溫新, 溫柔知  | 男, 女   | 二年級, 大班
```

**展開後格式（紅色）**：
```
項次 | 報名序號 | 兒童姓名 | 手足名稱 | 手足性別 | 手足年級
1    | 022      | 溫河     | 溫新     | 男       | 二年級
2    | 022      | 溫河     | 溫柔知   | 女       | 大班
```

### 4. **重新編號項次**
總表中的「項次」會從 1 開始重新編號，每一列（包括展開的手足列）都有獨立的項次。

### 5. **包含所有資料**
總表包含所有年級的學生資料，不分年級。

---

## Excel 輸出結構

### 分頁順序

```
1. 總表          ← 所有資料，依報名序號排序
2. 一年級        ← 只有一年級的學生
3. 二年級        ← 只有二年級的學生
4. 三年級        ← 只有三年級的學生
...
```

### 總表欄位

| 欄位名稱 | 說明 |
|---------|------|
| 項次 | 總表中的流水號（1, 2, 3...） |
| 報名序號 | 原始的報名序號（已排序） |
| 兒童姓名 | 參加活動的兒童姓名 |
| 性別 | 兒童性別 |
| 年級 | 兒童就讀年級 |
| 學校 | 就讀學校名稱 |
| 手足名稱 | 同一家長的其他孩子姓名 |
| 手足性別 | 手足的性別 |
| 手足年級 | 手足的年級 |
| 家長姓名 | 家長或監護人姓名 |
| 家長行動電話 | 聯絡電話 |
| 備註 | 其他備註資訊 |

---

## 排序邏輯

### 報名序號處理

系統會將報名序號轉換為數字進行排序：

```javascript
// 範例
"1"   → 1
"10"  → 10
"2"   → 2
"100" → 100

// 排序後
1, 2, 10, 100
```

### 空值處理

如果報名序號為空或無法轉換為數字，會被視為 `0`，排在最前面。

---

## 使用範例

### 輸入資料

假設有以下報名資料（未排序）：

| 報名序號 | 兒童姓名 | 年級 | 家長姓名 | 手足名稱 | 手足性別 | 手足年級 |
|---------|---------|------|---------|---------|---------|---------|
| 15 | 王小明 | 三年級 | 王大華 | 王小美 | 女 | 一年級 |
| 3 | 李小華 | 一年級 | 李媽媽 | 無 | 無 | 無 |
| 28 | 張小美 | 二年級 | 張爸爸 | 張小強, 張小花 | 男, 女 | 四年級, 大班 |
| 7 | 陳小強 | 一年級 | 陳媽媽 | 無 | 無 | 無 |

### 輸出結果

#### 總表（依報名序號排序，手足展開）

| 項次 | 報名序號 | 兒童姓名 | 年級 | 手足名稱 | 手足性別 | 手足年級 | 家長姓名 |
|-----|---------|---------|------|---------|---------|---------|---------|
| 1 | 3 | 李小華 | 一年級 | | | | 李媽媽 |
| 2 | 7 | 陳小強 | 一年級 | | | | 陳媽媽 |
| 3 | 15 | 王小明 | 三年級 | 王小美 | 女 | 一年級 | 王大華 |
| 4 | 28 | 張小美 | 二年級 | 張小強 | 男 | 四年級 | 張爸爸 |
| 5 | 28 | 張小美 | 二年級 | 張小花 | 女 | 大班 | 張爸爸 |

**說明**：
- 李小華和陳小強沒有手足，各佔一列
- 王小明有 1 個手足，佔 1 列
- 張小美有 2 個手足，展開成 2 列（項次 4 和 5）

#### 一年級分頁

| 項次 | 報名序號 | 兒童姓名 | 年級 |
|-----|---------|---------|------|
| 1 | 3 | 李小華 | 一年級 |
| 2 | 7 | 陳小強 | 一年級 |

#### 二年級分頁

| 項次 | 報名序號 | 兒童姓名 | 年級 |
|-----|---------|---------|------|
| 1 | 28 | 張小美 | 二年級 |

#### 三年級分頁

| 項次 | 報名序號 | 兒童姓名 | 年級 |
|-----|---------|---------|------|
| 1 | 15 | 王小明 | 三年級 |

---

## 技術實作

### 排序演算法

```javascript
// 依報名序號排序（正排序）
const sortedStudents = [...allStudents].sort((a, b) => {
  const numA = parseInt(a.報名序號) || 0;
  const numB = parseInt(b.報名序號) || 0;
  return numA - numB;
});
```

### 手足資料展開

```javascript
// 解析手足資料（逗號分隔）
const siblingNames = student.手足名稱.split(',').map(s => s.trim());
const siblingGenders = student.手足性別.split(',').map(s => s.trim());
const siblingGrades = student.手足年級.split(',').map(s => s.trim());

// 每個手足輸出一列
siblingNames.forEach((siblingName, idx) => {
  expandedRows.push({
    項次: currentIndex++,
    報名序號: student.報名序號,
    兒童姓名: student.兒童姓名,
    // ... 其他欄位
    手足名稱: siblingName,
    手足性別: siblingGenders[idx],
    手足年級: siblingGrades[idx],
    // ...
  });
});
```

### 重新編號

```javascript
// 項次會隨著展開的列自動遞增
let currentIndex = 1;
// 每加入一列，項次就 +1
expandedRows.push({ 項次: currentIndex++, ... });
```

---

## 常見問題

### Q1: 總表和年級分頁的項次有什麼不同？

**A**: 
- **總表的項次**：依報名序號排序後的流水號，包括展開的手足列
- **年級分頁的項次**：該年級內的流水號，手足資料不展開

例如：
- 總表：報名序號 3 的項次是 1，如果有 2 個手足，會佔項次 1 和 2
- 一年級分頁：報名序號 3 的項次是 1，手足資料用逗號分隔在同一列

### Q2: 如果報名序號不是連續的會怎樣？

**A**: 沒問題！系統只是依照報名序號的大小排序，不需要連續。

例如：1, 5, 10, 100 都可以正確排序。

### Q3: 如果報名序號是文字會怎樣？

**A**: 系統會嘗試轉換成數字。如果無法轉換（例如 "ABC"），會被視為 0。

### Q4: 可以改成依其他欄位排序嗎？

**A**: 可以！修改 `backend/src/services/excelService.js` 中的 `createSummarySheet` 函數：

```javascript
// 改成依兒童姓名排序
const sortedStudents = [...allStudents].sort((a, b) => {
  return a.兒童姓名.localeCompare(b.兒童姓名);
});

// 改成依年級排序
const sortedStudents = [...allStudents].sort((a, b) => {
  return a.年級.localeCompare(b.年級);
});
```

### Q5: 可以改成倒排序嗎？

**A**: 可以！只需要將 `return numA - numB` 改成 `return numB - numA`：

```javascript
const sortedStudents = [...allStudents].sort((a, b) => {
  const numA = parseInt(a.報名序號) || 0;
  const numB = parseInt(b.報名序號) || 0;
  return numB - numA; // 倒排序
});
```

---

## 優點

### 1. **快速查找**
依報名序號排序，可以快速找到特定編號的學生。

### 2. **完整總覽**
一個分頁就能看到所有學生資料，不用切換多個分頁。

### 3. **方便核對**
可以依序核對報名序號，確認是否有遺漏。

### 4. **彈性使用**
總表和年級分頁並存，可以依需求使用不同的檢視方式。

---

## 更新記錄

- **v1.2.0** (2024-11-25) - 新增總表功能，依報名序號排序

---

## 相關文件

- `README.md` - 專案主要說明
- `EXAMPLE_DATA.md` - Excel 範例資料格式
- `SYSTEM_FLOW.md` - 系統流程說明
- `快速參考.md` - 快速使用指南
